<div class="flex justify-start font-[var(--inter-font)] p-4">
  <div class="rounded-lg overflow-hidden border border-black/20 w-full">
    <div class="flex flex-col">
      <!-- Header -->
      <h1 class="text-base font-semibold text-[var(--full-contrast)] mx-4 my-2">
        Star Wars Fleet
      </h1>
      <!-- Search bar -->
      <div class="flex flex-row">
        <input type="text" placeholder="Search elements..."
          class="rounded-lg border border-blue-500 mx-4 my-2 pl-2 text-sm"
          (input)="starshipsService.setSearchQuery(($any($event.target)).value)" Æ’ />
        @if (((starshipsService.searchQuery$ | async) ?? '').length > 0) {
        <div class="text-sm text-gray-500 mt-2">
          {{ starshipsService.filteredCount$ | async }} elements
        </div>
        }
      </div>
    </div>
    <!-- Data grid -->
    <div class="relative min-h-[100px]">
      <div class="overflow-x-auto flex justify-start">
        <table ngGrid class="border-collapse bg-[var(--septenary-contrast)] table-fixed ml-0"
          [style.width.px]="tableWidth()">
          <colgroup>
            @for (w of colWidths(); track $index) {
            <col [style.width.px]="w" />
            }
          </colgroup>
          <thead class="[&_th]:px-4 [&_th]:py-3
          [&_th]:border-t 
         [&_th]:text-gray-500 [&_th]:font-semibold [&_th]:text-xs
         [&_th]:border-b [&_th]:border-r [&_th]:border-black/20
        [&_th]:break-words [&_th]:text-left">
            <!-- First row with column names -->
            <tr ngGridRow>
              @for(col of columns; track col.key; let i = $index){
              <th ngGridCell class="relative group select-none">
                {{ col.label }}
                <span class="absolute top-0 -right-1 h-full w-2 cursor-col-resize touch-none group-hover:bg-blue-500/20"
                  (pointerdown)="startResize($event, i)">
                </span>
              </th>
              }
            </tr>
          </thead>
          <!-- Data grid cells-->
          <tbody class="bg-[var(--octonary-contrast)]
               [&_td]:px-4 [&_td]:py-3
               [&_td]:border-b [&_td]:border-r [&_td]:border-black/20 [&_td]:text-sm
               [&_tr:last-child_td]:border-b-0
               [&_td]:break-words">
            @for (starship of (starshipsService.filteredStarships$ | async) ?? []; track starship.name) {
            <tr ngGridRow class="hover:bg-[var(--septenary-contrast)] focus-within:bg-[var(--septenary-contrast)]">
              @for(col of columns; track col.key; let i= $index){
              <td ngGridCell
                class="hover:ring-1 hover:ring-blue-500/60 focus-within:ring-1 focus-within:ring-blue-500/60">
                @if(col.key == 'name'){
                <div type="button" ngGridCellWidget aria-label="edit name" widgetType="editable"
                  class="group flex items-center justify-between gap-2 outline-none"
                  (onActivate)="startEdit($event, starship, nameInput)" (onDeactivate)="completeEdit($event, starship)"
                  #widget="ngGridCellWidget">
                  <div class="flex-1 min-w-0 overflow-hidden">
                    <span [class.hidden]="widget.isActivated()">{{ starship.name }}</span>
                    <input [class.hidden]="!widget.isActivated()"
                      class="w-full min-w-0 bg-transparent px-2 py-1 p-0 m-0 text-inherit text-sm leading-5"
                      [(ngModel)]="nameDraft" #nameInput />
                  </div>
                  <button tabindex="-1" aria-label="edit name"
                    class="material-symbols-outlined opacity-0 group-hover:opacity-100 group-focus-within:opacity-100 transition-opacity"
                    (click)="onClickEdit(widget)" [class.hidden]="widget.isActivated()" translate="no">
                    edit
                  </button>
                </div>
                } @else{
                {{ cellValue(starship, col.key) }}
                }
              </td>
              }
            </tr>
            }
          </tbody>
          <div #bottom class="h-px"></div>
        </table>
      </div>

      <!-- Sentinel -->
      <div #bottom class="h-px"></div>

      <!-- Error overlay -->
      @if (starshipsService.error$ | async; as err) {
      <div class="absolute inset-0 flex flex-col items-center justify-center gap-4
      bg-white text-red-500">
        <div class="text-xl">Error: {{ err }}</div>

        <button type="button" class="inline-flex items-center gap-2 rounded-lg border border-red-500 px-4 py-2 text-sm text-red-600
               hover:bg-red-500/10 disabled:opacity-50 disabled:cursor-not-allowed" (click)="starshipsService.retry()"
          [disabled]="(starshipsService.loading$ | async) === true">
          <span class="material-symbols-outlined text-[18px] leading-none" aria-hidden="true">refresh</span>
          Retry
        </button>
      </div>
      }
      <!-- No matches overlay -->
      @else if (((starshipsService.searchQuery$ | async) ?? '').length > 0
      && (starshipsService.filteredCount$ | async) === 0) {
      <div class="absolute inset-0 flex flex-col items-center justify-center
                bg-white text-gray-500">
        <div class="text-xl">No matches found</div>
        <span class="material-symbols-outlined !text-[36px] leading-none mt-2" aria-hidden="true">
          sentiment_dissatisfied
        </span>
      </div>
      }
    </div>

  </div>
</div>